<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalSun - Sunrise & Sunset Calendar</title>
    <style>
        /* CSS Custom Properties for consistent theming */
        :root {
            --color-primary: #111;
            --color-primary-hover: #333;
            --color-text: #111;
            --color-text-muted: #666;
            --color-background: #fff;
            --color-background-subtle: #fafafa;
            --color-border: #ddd;
            --color-border-light: #eee;
            --color-error: #c00;
            --color-success: #080;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
            --radius: 4px;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            max-width: 480px;
            margin: 0 auto;
            padding: 4rem 1.5rem;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
        }

        h1 {
            margin: 0 0 0.25rem 0;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .subtitle {
            color: var(--color-text-muted);
            margin-bottom: 3rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.75rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: var(--font-size-sm);
        }

        input[type="text"] {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: var(--font-size-base);
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .radio-option input {
            cursor: pointer;
        }

        button {
            padding: 0.625rem 1.25rem;
            border: 1px solid var(--color-primary);
            border-radius: var(--radius);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            background: var(--color-background);
            color: var(--color-primary);
        }

        button:hover {
            background: var(--color-primary);
            color: var(--color-background);
        }

        .btn-primary {
            width: 100%;
            background: var(--color-primary);
            color: var(--color-background);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result {
            display: none;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--color-border-light);
        }

        .result.show {
            display: block;
        }

        .result-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            margin-bottom: 0.5rem;
        }

        .result-url {
            word-break: break-all;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            padding: 0.75rem;
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            background: var(--color-background-subtle);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        .btn-group button {
            flex: 1;
        }

        .error {
            color: var(--color-error);
            font-size: var(--font-size-sm);
            margin-top: 0.5rem;
        }

        .success {
            color: var(--color-success);
            font-size: var(--font-size-sm);
            margin-top: 0.5rem;
        }

        .location-info {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>CalSun</h1>
    <p class="subtitle">Subscribe to sunrise & sunset times in your calendar</p>

    <form id="calForm">
        <div class="form-group">
            <label for="address">Location</label>
            <input type="text" id="address" placeholder="Enter city, address, or coordinates..." required>
            <div id="locationInfo" class="location-info"></div>
            <div id="addressError" class="error"></div>
        </div>

        <div class="form-group">
            <label>Events to include</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="events" value="both" checked>
                    Both sunrise and sunset
                </label>
                <label class="radio-option">
                    <input type="radio" name="events" value="sunrise">
                    Sunrise only
                </label>
                <label class="radio-option">
                    <input type="radio" name="events" value="sunset">
                    Sunset only
                </label>
            </div>
        </div>

        <button type="submit" class="btn-primary" id="generateBtn">Generate Calendar Link</button>
    </form>

    <div id="result" class="result">
        <div class="result-label">Your calendar subscription URL:</div>
        <div id="resultUrl" class="result-url"></div>
        <div class="btn-group">
            <button type="button" id="copyBtn">Copy URL</button>
            <button type="button" id="subscribeBtn">Add to Calendar</button>
        </div>
        <div id="copySuccess" class="success"></div>
    </div>

    <script>
        // Configuration constants
        const DEBOUNCE_DELAY_MS = 500;
        const SUCCESS_MESSAGE_DURATION_MS = 2000;
        const COORDINATE_PATTERNS = [
            /^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/,  // "55.67, 12.56"
            /^(-?\d+\.?\d*)\s+(-?\d+\.?\d*)$/       // "55.67 12.56"
        ];

        // Current location state
        let currentLocation = { lat: null, lng: null, name: null };
        let debounceTimer = null;

        // DOM element references
        const elements = {
            addressInput: document.getElementById('address'),
            locationInfo: document.getElementById('locationInfo'),
            addressError: document.getElementById('addressError'),
            calForm: document.getElementById('calForm'),
            resultSection: document.getElementById('result'),
            resultUrl: document.getElementById('resultUrl'),
            copyBtn: document.getElementById('copyBtn'),
            subscribeBtn: document.getElementById('subscribeBtn'),
            copySuccess: document.getElementById('copySuccess')
        };

        // Utility: Show temporary success message
        function showSuccessMessage(message) {
            elements.copySuccess.textContent = message;
            setTimeout(() => { elements.copySuccess.textContent = ''; }, SUCCESS_MESSAGE_DURATION_MS);
        }

        // Utility: Copy text to clipboard with fallback for older browsers
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        // Utility: Format coordinates for display
        function formatCoordinates(lat, lng) {
            return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }

        // Utility: Check if coordinates are valid
        function isValidCoordinate(lat, lng) {
            return lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
        }

        // Utility: Update current location state
        function setCurrentLocation(lat, lng, name) {
            currentLocation = { lat, lng, name };
        }

        // Utility: Clear current location state
        function clearCurrentLocation() {
            setCurrentLocation(null, null, null);
        }

        // Parse input string as coordinates if possible
        function parseCoordinates(input) {
            for (const pattern of COORDINATE_PATTERNS) {
                const match = input.match(pattern);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    if (isValidCoordinate(lat, lng)) {
                        return { lat, lng, name: formatCoordinates(lat, lng) };
                    }
                }
            }
            return null;
        }

        // Geocode address using OpenStreetMap Nominatim API
        async function geocodeAddress(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;

            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'CalSun Calendar Service' }
                });

                if (!response.ok) {
                    throw new Error('Geocoding failed');
                }

                const data = await response.json();
                if (data.length === 0) {
                    return null;
                }

                return {
                    lat: parseFloat(data[0].lat),
                    lng: parseFloat(data[0].lon),
                    name: data[0].display_name.split(',')[0]
                };
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Build calendar subscription URL from current state
        function buildCalendarUrl() {
            const baseUrl = `${window.location.origin}/calendar.ics`;
            const params = new URLSearchParams();

            params.set('lat', currentLocation.lat.toFixed(6));
            params.set('lng', currentLocation.lng.toFixed(6));

            if (currentLocation.name) {
                params.set('name', currentLocation.name);
            }

            const selectedEvents = document.querySelector('input[name="events"]:checked').value;
            if (selectedEvents === 'sunrise') {
                params.set('exclude', 'sunset');
            } else if (selectedEvents === 'sunset') {
                params.set('exclude', 'sunrise');
            }

            return `${baseUrl}?${params.toString()}`;
        }

        // Convert HTTP(S) URL to webcal URL for calendar subscription
        function toWebcalUrl(url) {
            return url.replace(/^https?:\/\//, 'webcal://');
        }

        // Handle address input changes with debounced geocoding
        elements.addressInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            clearCurrentLocation();
            elements.locationInfo.textContent = '';
            elements.addressError.textContent = '';

            const value = this.value.trim();
            if (!value) {
                return;
            }

            // Try parsing as coordinates first (no API call needed)
            const coords = parseCoordinates(value);
            if (coords) {
                setCurrentLocation(coords.lat, coords.lng, coords.name);
                elements.locationInfo.textContent = `Coordinates: ${formatCoordinates(coords.lat, coords.lng)}`;
                return;
            }

            // Debounce geocoding API requests
            debounceTimer = setTimeout(async () => {
                elements.locationInfo.textContent = 'Looking up location...';

                const geocodeResult = await geocodeAddress(value);
                if (geocodeResult) {
                    setCurrentLocation(geocodeResult.lat, geocodeResult.lng, geocodeResult.name);
                    elements.locationInfo.textContent = `Found: ${geocodeResult.name} (${formatCoordinates(geocodeResult.lat, geocodeResult.lng)})`;
                    elements.addressError.textContent = '';
                } else {
                    elements.locationInfo.textContent = '';
                    elements.addressError.textContent = 'Location not found. Try a different search or enter coordinates directly.';
                }
            }, DEBOUNCE_DELAY_MS);
        });

        // Handle form submission
        elements.calForm.addEventListener('submit', function(e) {
            e.preventDefault();

            if (currentLocation.lat === null || currentLocation.lng === null) {
                elements.addressError.textContent = 'Please enter a valid location';
                return;
            }

            const calUrl = buildCalendarUrl();

            elements.resultUrl.textContent = calUrl;
            elements.resultSection.classList.add('show');
            elements.copySuccess.textContent = '';
        });

        // Handle subscribe button click
        elements.subscribeBtn.addEventListener('click', function() {
            const calUrl = elements.resultUrl.textContent;
            if (calUrl) {
                window.location.href = toWebcalUrl(calUrl);
            }
        });

        // Handle copy button click
        elements.copyBtn.addEventListener('click', async function() {
            await copyToClipboard(elements.resultUrl.textContent);
            showSuccessMessage('Copied to clipboard!');
        });
    </script>
</body>
</html>
